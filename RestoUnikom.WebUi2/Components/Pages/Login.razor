@page "/login"
@inject RestoUnikom.WebUi2.Authentication.CustomAuthenticationStateProvider AuthService
@inject NavigationManager Navigation
@inject MudBlazor.ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="py-4">
    <MudPaper Elevation="2" Class="pa-6">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">Login</MudText>
        <MudForm @ref="_form">
            <MudTextField T="string" Label="Nama Pengguna" @bind-Value="_namaPengguna"
                          Variant="Variant.Outlined" Required="true" Class="mb-4"
                          OnKeyDown="HandleKeyDown" />
            <MudTextField T="string" Label="Kata Sandi" @bind-Value="_kataSandi"
                          Variant="Variant.Outlined" InputType="InputType.Password"
                          Required="false" Class="mb-4"
                          OnKeyDown="HandleKeyDown" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                       Disabled="@(string.IsNullOrWhiteSpace(_namaPengguna) || _isProcessing)"
                       OnClick="SubmitLogin">
                @if (_isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Login
            </MudButton>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm _form = null!;
    private bool _isProcessing = false;
    private string _namaPengguna = string.Empty;
    private string _kataSandi = string.Empty;

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        Console.WriteLine($"Key pressed: {e.Key}"); // Debug
        if (e.Key == "Enter")
        {
            Console.WriteLine("Enter detected, calling SubmitLogin"); // Debug
            await SubmitLogin();
        }
    }

    private async Task SubmitLogin()
    {
        if (string.IsNullOrWhiteSpace(_namaPengguna)) return;

        _isProcessing = true;
        try
        {
            await AuthService.LoginAsync(_namaPengguna, _kataSandi);
            Snackbar.Add("Login berhasil!", Severity.Success);
            Navigation.NavigateTo("/pemesanan", forceLoad: true);
        }
        catch
        {
            Snackbar.Add("Nama pengguna atau kata sandi salah!", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
        }
    }
}